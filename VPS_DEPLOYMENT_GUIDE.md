# Authflow VPS Deployment Guide
**Complete guide to deploy Authflow on any VPS (Ubuntu/Debian)**

---

## üìã Prerequisites

### What You Need:
1. **VPS Server** - Ubuntu 22.04+ or Debian 11+ (2 CPU, 4GB RAM minimum)
2. **Domain Name** (optional but recommended) - e.g., `auth.yourdomain.com`
3. **SSH Access** to your VPS
4. **Resend API Key** (for emails) - Get from https://resend.com (free tier: 3,000 emails/month)

### Providers Tested:
- ‚úÖ DigitalOcean ($4-48/month)
- ‚úÖ Hetzner (‚Ç¨4-40/month)
- ‚úÖ Vultr ($6-48/month)
- ‚úÖ Linode ($5-48/month)
- ‚úÖ AWS Lightsail ($3.50-40/month)

---

## üöÄ Quick Deploy (Automated Script)

### Step 1: SSH into Your VPS
```bash
ssh root@your-vps-ip
```

### Step 2: Run the Auto-Install Script
```bash
# Download and run the deployment script
curl -fsSL https://raw.githubusercontent.com/yourusername/authflow/main/deploy/install.sh | bash
```

The script automatically:
- ‚úÖ Installs Node.js, PostgreSQL, Nginx
- ‚úÖ Sets up Authflow application
- ‚úÖ Configures SSL (Let's Encrypt)
- ‚úÖ Sets up systemd service (auto-restart)
- ‚úÖ Creates database and runs migrations

### Step 3: Configure Secrets
After installation, edit the environment file:
```bash
nano /opt/authflow/.env
```

Add your secrets:
```bash
# Database (auto-generated by script)
DATABASE_URL=postgresql://authflow:RANDOM_PASSWORD@localhost:5432/authflow

# Authentication Secrets (generate below)
SESSION_SECRET=your_session_secret_here
JWT_SECRET=your_jwt_secret_here

# Email Service (REQUIRED)
RESEND_API_KEY=re_xxxxxxxxxxxxx

# Optional OAuth Providers
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
GITHUB_CLIENT_ID=
GITHUB_CLIENT_SECRET=

# Application Settings
NODE_ENV=production
PORT=3000
```

**Generate secure secrets:**
```bash
# Run these commands to generate random secrets
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"  # Use for SESSION_SECRET
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"  # Use for JWT_SECRET
```

### Step 4: Restart Service
```bash
systemctl restart authflow
systemctl status authflow  # Check if running
```

### Step 5: Access Your Platform
- **HTTP:** http://your-vps-ip
- **HTTPS:** https://your-domain.com (if domain configured)

---

## üîß Manual Installation (Step-by-Step)

If you prefer manual setup or the script fails:

### 1. Update System
```bash
apt update && apt upgrade -y
```

### 2. Install Node.js 20
```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs
node --version  # Should show v20.x
```

### 3. Install PostgreSQL
```bash
apt install -y postgresql postgresql-contrib
systemctl start postgresql
systemctl enable postgresql

# Create database and user
sudo -u postgres psql << EOF
CREATE DATABASE authflow;
CREATE USER authflow WITH ENCRYPTED PASSWORD 'YOUR_SECURE_PASSWORD';
GRANT ALL PRIVILEGES ON DATABASE authflow TO authflow;
\q
EOF
```

### 4. Install Authflow
```bash
# Create app directory
mkdir -p /opt/authflow
cd /opt/authflow

# Clone your repository (replace with your repo URL)
git clone https://github.com/yourusername/authflow.git .

# Install dependencies
npm install

# Build the application
npm run build
```

### 5. Configure Environment
```bash
nano /opt/authflow/.env
```

Add the configuration from Step 3 above.

### 6. Push Database Schema
```bash
npm run db:push
```

### 7. Create Systemd Service
```bash
nano /etc/systemd/system/authflow.service
```

Add this content:
```ini
[Unit]
Description=Authflow Authentication Platform
After=network.target postgresql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/authflow
EnvironmentFile=/opt/authflow/.env
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
systemctl daemon-reload
systemctl enable authflow
systemctl start authflow
systemctl status authflow
```

### 8. Install Nginx (Reverse Proxy)
```bash
apt install -y nginx

nano /etc/nginx/sites-available/authflow
```

Add this configuration:
```nginx
server {
    listen 80;
    server_name your-domain.com;  # Replace with your domain

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket support for real-time notifications
    location /socket.io/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Enable the site:
```bash
ln -s /etc/nginx/sites-available/authflow /etc/nginx/sites-enabled/
nginx -t  # Test configuration
systemctl restart nginx
```

### 9. Install SSL Certificate (HTTPS)
```bash
# Install Certbot
apt install -y certbot python3-certbot-nginx

# Get SSL certificate (replace with your domain)
certbot --nginx -d your-domain.com
```

Certbot will automatically:
- Obtain SSL certificate
- Configure Nginx for HTTPS
- Set up auto-renewal

---

## üîí Security Hardening

### 1. Firewall Setup
```bash
# Install UFW firewall
apt install -y ufw

# Allow SSH, HTTP, HTTPS
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp

# Enable firewall
ufw enable
ufw status
```

### 2. Secure PostgreSQL
```bash
# Edit PostgreSQL config
nano /etc/postgresql/14/main/postgresql.conf

# Change:
listen_addresses = 'localhost'  # Only local connections

# Restart PostgreSQL
systemctl restart postgresql
```

### 3. Enable Automatic Updates
```bash
apt install -y unattended-upgrades
dpkg-reconfigure -plow unattended-upgrades
```

### 4. Set Up Log Rotation
```bash
nano /etc/logrotate.d/authflow
```

Add:
```
/opt/authflow/logs/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    missingok
    create 0640 root root
}
```

---

## üìä Monitoring & Maintenance

### Check Application Status
```bash
systemctl status authflow
journalctl -u authflow -f  # View live logs
```

### Database Backup
```bash
# Manual backup
sudo -u postgres pg_dump authflow > /backup/authflow_$(date +%Y%m%d).sql

# Automated daily backup (cron)
crontab -e
# Add this line:
0 2 * * * sudo -u postgres pg_dump authflow > /backup/authflow_$(date +\%Y\%m\%d).sql
```

### Update Application
```bash
cd /opt/authflow
git pull origin main
npm install
npm run build
systemctl restart authflow
```

### Monitor Resources
```bash
# CPU, Memory, Disk usage
htop

# Disk space
df -h

# Database size
sudo -u postgres psql -c "SELECT pg_size_pretty(pg_database_size('authflow'));"
```

---

## üî• Production Optimizations

### 1. Enable Production Mode
In `/opt/authflow/.env`:
```bash
NODE_ENV=production
```

### 2. Process Manager (PM2) - Optional Alternative
If you prefer PM2 over systemd:
```bash
npm install -g pm2
pm2 start npm --name authflow -- start
pm2 startup  # Auto-start on boot
pm2 save
```

### 3. Database Connection Pooling
Already configured in the app, but verify in `server/db.ts`:
- Max connections: 10
- Idle timeout: 30s

### 4. Nginx Caching (Optional)
Add to Nginx config for static assets:
```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

---

## üåç DNS Configuration

### Point Your Domain to VPS
Add these DNS records at your domain provider:

**A Record:**
```
Type: A
Name: auth (or @)
Value: YOUR_VPS_IP
TTL: 3600
```

**Optional CNAME (for www):**
```
Type: CNAME
Name: www
Value: auth.yourdomain.com
TTL: 3600
```

Wait 5-60 minutes for DNS propagation.

---

## üß™ Verification Checklist

After deployment, test everything:

- [ ] Visit https://your-domain.com (loads without errors)
- [ ] Register new account (email verification sent)
- [ ] Login works
- [ ] Password reset works
- [ ] MFA setup works (TOTP and Email)
- [ ] Magic link login works
- [ ] WebAuthn/FIDO2 works (if device supports)
- [ ] Admin dashboard accessible
- [ ] Real-time notifications work
- [ ] API endpoints respond correctly
- [ ] SSL certificate valid (green padlock)
- [ ] WebSocket connections work

---

## üÜò Troubleshooting

### Application Won't Start
```bash
# Check logs
journalctl -u authflow -n 100

# Common issues:
# - Missing .env file
# - Wrong DATABASE_URL
# - Missing NODE_ENV
```

### Database Connection Failed
```bash
# Test database connection
sudo -u postgres psql authflow

# Check PostgreSQL is running
systemctl status postgresql

# Verify DATABASE_URL in .env matches database credentials
```

### Email Not Sending
```bash
# Check RESEND_API_KEY is set
cat /opt/authflow/.env | grep RESEND

# Test email service
curl -X POST https://api.resend.com/emails \
  -H "Authorization: Bearer YOUR_RESEND_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"from":"onboarding@resend.dev","to":"test@example.com","subject":"Test","html":"Test"}'
```

### Nginx Errors
```bash
# Test Nginx config
nginx -t

# Check Nginx logs
tail -f /var/log/nginx/error.log

# Restart Nginx
systemctl restart nginx
```

### SSL Certificate Issues
```bash
# Renew certificate manually
certbot renew

# Check certificate status
certbot certificates
```

---

## üí∞ Cost Breakdown (Real Numbers)

### Recommended Setup for Starting:

**VPS (Hetzner CPX21):**
- 2 vCPU, 4GB RAM, 80GB SSD
- **Cost:** ‚Ç¨8.46/month (~$9/month)
- **Handles:** 5,000-10,000 users easily

**Domain:**
- .com domain from Namecheap
- **Cost:** $10/year

**Email Service (Resend):**
- Free tier: 3,000 emails/month
- **Cost:** $0/month (then $20/month for 50k emails)

**SSL Certificate:**
- Let's Encrypt (free)
- **Cost:** $0

**TOTAL STARTUP COST:**
- **Monthly:** $9
- **Yearly:** ~$120

### Scaling Costs:

**10,000 users:**
- VPS: $20/month (4GB RAM)
- Emails: $20/month
- **Total:** $40/month

**50,000 users:**
- VPS: $40/month (8GB RAM)
- Managed DB: $30/month
- Emails: $40/month
- CDN: $10/month
- **Total:** $120/month

**100,000+ users:**
- Multiple VPS + Load Balancer: $100-200/month
- Managed DB (HA): $60-100/month
- Emails: $80/month
- CDN + Monitoring: $30/month
- **Total:** $270-410/month

---

## üì¶ Deployment Script (Auto-Install)

Save this as `deploy/install.sh` in your repository:

```bash
#!/bin/bash
set -e

echo "üöÄ Installing Authflow on VPS..."

# Update system
apt update && apt upgrade -y

# Install Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs

# Install PostgreSQL
apt install -y postgresql postgresql-contrib

# Generate random password for database
DB_PASSWORD=$(openssl rand -base64 32)

# Create database
sudo -u postgres psql << EOF
CREATE DATABASE authflow;
CREATE USER authflow WITH ENCRYPTED PASSWORD '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON DATABASE authflow TO authflow;
\q
EOF

# Create app directory
mkdir -p /opt/authflow
cd /opt/authflow

# Clone repository (user will replace URL)
read -p "Enter your GitHub repository URL: " REPO_URL
git clone $REPO_URL .

# Install dependencies
npm install

# Create .env file
cat > /opt/authflow/.env << EOF
DATABASE_URL=postgresql://authflow:$DB_PASSWORD@localhost:5432/authflow
NODE_ENV=production
PORT=3000
SESSION_SECRET=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex'))")
JWT_SECRET=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex'))")
EOF

echo "‚ö†Ô∏è  IMPORTANT: Add your RESEND_API_KEY to /opt/authflow/.env"

# Push database schema
npm run db:push

# Create systemd service
cat > /etc/systemd/system/authflow.service << 'EOF'
[Unit]
Description=Authflow Authentication Platform
After=network.target postgresql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/authflow
EnvironmentFile=/opt/authflow/.env
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Enable and start service
systemctl daemon-reload
systemctl enable authflow
systemctl start authflow

# Install Nginx
apt install -y nginx

# Install Certbot (SSL)
apt install -y certbot python3-certbot-nginx

# Setup firewall
apt install -y ufw
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

echo "‚úÖ Authflow installed successfully!"
echo ""
echo "üìù Next steps:"
echo "1. Add RESEND_API_KEY to /opt/authflow/.env"
echo "2. Configure Nginx for your domain in /etc/nginx/sites-available/authflow"
echo "3. Run: certbot --nginx -d your-domain.com"
echo "4. Restart: systemctl restart authflow"
echo ""
echo "üîó Access your platform at: http://$(curl -s ifconfig.me)"
```

---

## üéØ Summary

**Minimum VPS Requirements:**
- 2 CPU, 4GB RAM, 20GB SSD
- Ubuntu 22.04 or Debian 11+
- $9-20/month

**Setup Time:**
- Automated: 10-15 minutes
- Manual: 30-45 minutes

**Monthly Costs:**
- Startup: $9-15/month
- Growing: $40-60/month
- Production: $120-200/month

**What You Get:**
- ‚úÖ Full authentication platform
- ‚úÖ Auto-restart on crashes
- ‚úÖ SSL/HTTPS enabled
- ‚úÖ Database backups configured
- ‚úÖ Production-ready setup

---

**Ready to deploy? Let me know and I'll help you through each step!**
